type: application
language: rust
toolchain:
  rust:
    version: 1.78.0
tags:
  - 'rust-channel-1.78.0'

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GCS_KEY_PREFIX: gasp-avs

fileGroups:
  sources:
    - 'src/**/*'
    - 'bindings/**/*'
    - 'Cargo.toml'

tasks:
  prepare-toolchain:
    command: rustup show
    options:
      cache: false

  build:
    command: cargo build --release
    inputs: ['@globs(sources)']
    outputs: ['target/release/main']

  build-image-local:
    command: 'docker buildx build --build-arg ROLLUP_NODE_VERSION=local -t gaspxyz/gasp-avs:local .'
    options:
      envFile: '/.env'
    deps: ['gasp-node:build-image-local']
    inputs: ['@globs(sources)', 'Dockerfile']
  
  build-ci:
    command: cargo build --release
    inputs: ['@globs(sources)']
    outputs: ['target/release/main']
    env:
      SCCACHE_GCS_KEY_PREFIX: gasp-avs-release
  
  build-image-ci-gasp-avs:
    script: |
      docker buildx build --platform linux/amd64 --build-arg ROLLUP_NODE_BINARY_PATH=gasp-node/target-standard-runtime/release/rollup-node -t gaspxyz/gasp-avs:${IMAGE_TAG:-ci} -f Dockerfile.ci --push ../
      docker buildx build --platform linux/amd64 --build-arg ROLLUP_NODE_BINARY_PATH=gasp-node/target-fast-runtime/release/rollup-node -t gaspxyz/gasp-avs:${IMAGE_TAG:-ci}-fast -f Dockerfile.ci --push ../
      docker buildx build --platform linux/amd64 --build-arg ROLLUP_NODE_BINARY_PATH=gasp-node/target-unlocked-runtime/release/rollup-node -t gaspxyz/gasp-avs:${IMAGE_TAG:-ci}-unlocked -f Dockerfile.ci --push ../
    deps: ['build-ci', 'gasp-node:build-image-ci-gasp-node']
    options:
      cache: false
      runDepsInParallel: false

  format-gasp-avs:
    command: cargo fmt --all -- --check
    inputs: ['@globs(sources)', 'tests/**/*']

  lint-gasp-avs:
    command: cargo clippy
    inputs: ['@globs(sources)', 'tests/**/*']

  test-gasp-avs:
    command: cargo test
    inputs: ['@globs(sources)', 'tests/**/*']