package aggregator

import (
	"context"
	"encoding/json"
	"errors"
	"net/http"
	// "io"
	// "strings"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"fmt"
	"encoding/hex"

	taskmanager "github.com/mangata-finance/eigen-layer-monorepo/avs-aggregator/bindings/FinalizerTaskManager"
	"github.com/mangata-finance/eigen-layer-monorepo/avs-aggregator/core"

	"github.com/Layr-Labs/eigensdk-go/crypto/bls"
	"github.com/Layr-Labs/eigensdk-go/services/bls_aggregation"
	"github.com/Layr-Labs/eigensdk-go/types"
	sdktypes "github.com/Layr-Labs/eigensdk-go/types"
)

var (
	TaskNotFoundError400                     = errors.New("400. Task not found")
	OperatorNotPartOfTaskQuorum400           = errors.New("400. Operator not part of quorum")
	OperatorNotRegistered400                 = errors.New("400. Operator not registered in AVS")
	TaskResponseDigestNotFoundError500       = errors.New("500. Failed to get task response digest")
	UnknownErrorWhileVerifyingSignature400   = errors.New("400. Failed to verify signature")
	SignatureVerificationFailed400           = errors.New("400. Signature verification failed")
	CallToGetCheckSignaturesIndicesFailed500 = errors.New("500. Failed to get check signatures indices")
)

func (agg *Aggregator) startServer(ctx context.Context) error {
	http.HandleFunc("/", agg.handler)
	err := http.ListenAndServe(agg.serverIpPortAddr, nil)
	if err != nil {
		agg.logger.Fatal("ListenAndServe", "err", err)
	}

	return nil
}

func (agg *Aggregator) handler(w http.ResponseWriter, req *http.Request) {
	switch req.Method {
	case http.MethodConnect:
		http.Error(w, "Operator not supported, please upgrade to latest", http.StatusUpgradeRequired)
		return
	case http.MethodPost:
		break
	default:
		http.Error(w, "Method not supported", http.StatusMethodNotAllowed)
		return
	}

	// buf := new(strings.Builder)
	// io.Copy(buf, req.Body)

	// agg.logger.Info("handler", "req.Body", buf.String())

	var response SignedTaskResponse
	if err := json.NewDecoder(req.Body).Decode(&response); err != nil {
		http.Error(w, "Error parsing request body", http.StatusBadRequest)
		return
	}

	// agg.logger.Info("handler", "response", response)

	if err := agg.ProcessSignedTaskResponse(&response, nil); err != nil {
		var status int
		switch err {
		case TaskResponseDigestNotFoundError500, CallToGetCheckSignaturesIndicesFailed500:
			status = http.StatusInternalServerError
		default:
			switch err.Error() {
			// case blsagg.TaskNotFoundErrorFn(response.TaskResponse.ReferenceTaskIndex).Error():
			case blsagg.TaskNotFoundErrorFn(0).Error():
				status = http.StatusNotFound
			default:
				status = http.StatusBadRequest
			}
		}
		http.Error(w, err.Error(), status)
		return
	}
}

type SignedTaskResponse struct {
	TaskResponse string
	BlsSignature bls.Signature
	OperatorId   types.OperatorId
}

// rpc endpoint which is called by operator
// reply doesn't need to be checked. If there are no errors, the task response is accepted
// rpc framework forces a reply type to exist, so we put bool as a placeholder
func (agg *Aggregator) ProcessSignedTaskResponse(signedTaskResponse *SignedTaskResponse, reply *bool) error {
	agg.logger.Info("Received signed task response", "response", signedTaskResponse, "operatorId", signedTaskResponse.OperatorId.LogValue())

	task_response_bytes, err := hex.DecodeString(signedTaskResponse.TaskResponse[2:])
	fmt.Print("ProcessSignedTaskResponse - task_response_bytes:",task_response_bytes, "\n")
	if err != nil {
		agg.logger.Error("Failed to get task_response_bytes", "err", err)
		return TaskResponseDigestNotFoundError500
	}

	var taskResponse taskmanager.IFinalizerTaskManagerTaskResponse

	parsedAbi, err := taskmanager.ContractFinalizerTaskManagerMetaData.GetAbi()
	// replace with dummy function?
	inputParameters := parsedAbi.Methods["respondToTask"].Inputs
	args := inputParameters[1:2]
	agg.logger.Info("ProcessSignedTaskResponse", "inputParameters", inputParameters)
	agg.logger.Info("ProcessSignedTaskResponse", "args", args)
	unpacked, err := args.Unpack(task_response_bytes)
	agg.logger.Info("ProcessSignedTaskResponse", "unpacked", unpacked)
	if err != nil {
		agg.logger.Error("Failed to get task response", "err", err)
		return TaskResponseDigestNotFoundError500
	}
	x := abi.ConvertType(unpacked[0], taskResponse)
	fmt.Print("ProcessSignedTaskResponse - x:",x, "\n")
	cx, ok := x.(taskmanager.IFinalizerTaskManagerTaskResponse)
	fmt.Print("ProcessSignedTaskResponse - ok:",ok, "\n")
	fmt.Print("ProcessSignedTaskResponse - cx:",cx, "\n")

	taskResponse = cx

	taskIndex := taskResponse.ReferenceTaskIndex
	taskResponseDigest, err := core.GetTaskResponseDigest(&taskResponse)
	if err != nil {
		agg.logger.Error("Failed to get task response digest", "err", err)
		return TaskResponseDigestNotFoundError500
	}
	if signedTaskResponse.OperatorId == [32]byte{} {
		agg.logger.Error("Operator not registered", "err", err)
		return OperatorNotRegistered400
	}
	agg.taskResponsesMu.Lock()
	if _, ok := agg.taskResponses[taskIndex]; !ok {
		agg.taskResponses[taskIndex] = make(map[sdktypes.TaskResponseDigest]taskmanager.IFinalizerTaskManagerTaskResponse)
	}
	if _, ok := agg.taskResponses[taskIndex][taskResponseDigest]; !ok {
		agg.taskResponses[taskIndex][taskResponseDigest] = taskResponse
	}
	agg.taskResponsesMu.Unlock()

	err = agg.blsAggregationService.ProcessNewSignature(
		context.Background(), taskIndex, taskResponseDigest,
		&signedTaskResponse.BlsSignature, signedTaskResponse.OperatorId,
	)
	return err
}

// 2024-06-20T12:45:31.390Z	INFO	avs-aggregator/rpc_server.go:98	Received signed task response	{"response": {"TaskResponse":"0x000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000200605dd12d9af652d742dae624aed0424d0b0cf65f7dd90e32b4e456d0010b00b9f66c3425fb1a8a174b030ad50ccecccb99eb5b3670f33c926712a4126d029e111fbc131f4eafcddc650de1519b37f71f6b9a864523c83f16392f4798cc2eb9190000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064037e2792cb1755f748cc795cb161b766a0bb65504d1e5ca7d7a8f0ad4fafc67903d0f5a11285e6105b6452c9a2fba8187663d2724a6910f9fafdc02a8a960298000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204a93ad7629ff117254cbb91a60aada1ffcdd87aa950b7d064fa0bae59a882072000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","BlsSignature":{"g1_point":{"X":"12066774600639407917845036252136541481597163952556322551008700962361642525129","Y":"16049923660373651547693585393368908300058181868232222898601000628962564534594"}},"OperatorId":[74,147,173,118,41,255,17,114,84,203,185,26,96,170,218,31,252,221,135,170,149,11,125,6,79,160,186,229,154,136,32,114]}, "operatorId": "4a93ad7629ff117254cbb91a60aada1ffcdd87aa950b7d064fa0bae59a882072"}

// "{\"TaskResponse\":\"0x000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000200605dd12d9af652d742dae624aed0424d0b0cf65f7dd90e32b4e456d0010b00b9f66c3425fb1a8a174b030ad50ccecccb99eb5b3670f33c926712a4126d029e111fbc131f4eafcddc650de1519b37f71f6b9a864523c83f16392f4798cc2eb9190000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064037e2792cb1755f748cc795cb161b766a0bb65504d1e5ca7d7a8f0ad4fafc67903d0f5a11285e6105b6452c9a2fba8187663d2724a6910f9fafdc02a8a960298000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204a93ad7629ff117254cbb91a60aada1ffcdd87aa950b7d064fa0bae59a882072000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"BlsSignature\":{\"g1_point\":{\"X\":\"12066774600639407917845036252136541481597163952556322551008700962361642525129\",\"Y\":\"16049923660373651547693585393368908300058181868232222898601000628962564534594\"}},\"OperatorId\":[74,147,173,118,41,255,17,114,84,203,185,26,96,170,218,31,252,221,135,170,149,11,125,6,79,160,186,229,154,136,32,114]}"