language: solidity
type: application

toolchain:
  default: bun
  bun:
    version: 1.2.2

fileGroups:
  sources:
    - "lib/**/*"
    - "src/**/*"
    - "test/**/*"
    - "script/**/*"
    - "tools/**/*"
    - package.json
    - foundry.toml
    - remappings.txt

tasks:
  build:
    command: "forge build"
    inputs: ["@globs(sources)"]
    outputs: ["out"]
  
  build-image-local:
    command: >
      docker buildx build
      --platform linux/amd64
      --tag gaspxyz/gasp-contracts:local
      --tag gaspxyz/gasp-contracts:localarb
      --tag gaspxyz/gasp-contracts:localbase
      --load
      .
    inputs: ["@globs(sources)", "Dockerfile"]

  contracts-build-image-ci:
    command: >
      docker buildx build
      --push
      --platform linux/amd64
      --tag gaspxyz/gasp-contracts:${IMAGE_TAG:-ci}
      .
    inputs: ["@globs(sources)", "Dockerfile"]
    options:
      cache: false

  contracts-format:
    command: bun run format
    inputs: ["@globs(sources)"]

  contracts-lint:
    command: bun run lint
    inputs: ["@globs(sources)"]

  contracts-test:
    command: bun run test
    inputs: ["@globs(sources)"]

  contracts-size:
    command: bun run size
    inputs: ["@globs(sources)"]

  contracts-gas:
    command: bun run gas
    inputs: ["@globs(sources)"]

  contracts-coverage:
    command: bun run cover
    inputs: ["@globs(sources)"]

  bun-install:
    command: bun install
    inputs: ["@globs(sources)"]
    options:
      runInCI: false
      cache: false

  contracts-check:
    deps: ['contracts-format', 'contracts-lint', 'contracts-test', 'contracts-size', 'contracts-gas', 'contracts-coverage']

  contracts-check-addresses:
    script: |
      docker compose down
      docker compose up --wait eth-contracts-deployment arbitrum-contracts-deployment base-contracts-deployment
      git diff --exit-code contracts/script/output/
    options:
      runFromWorkspaceRoot: true

  release:
    command: bun run release
    inputs: ["@globs(sources)"]
    options:
      cache: false
      runInCI: false
