# Use IMAGE_TAG environment variable with fallback to "ci"
default_version := env_var_or_default("IMAGE_TAG", "ci")

# Default recipe
default:
  @just --list

start-env:
  @docker compose up -d
  
stop-env:
  @docker compose down

reset-env:
  @just stop-env
  @just start-env

# Common setup for all e2e tests
setup-e2e-env:
    @echo "Setting up e2e test environment..."
    just reset-env && sleep 10
    cd ../gasp-e2e && yarn install
    rm -rf ../gasp-e2e/reports/*.xml || true
    mkdir -p ../gasp-e2e/reports

# Run a specific e2e test with the given runtime image tag
run-e2e-test test gasp_node_image_tag:
    @echo "Running {{test}} with gasp-node image tag {{gasp_node_image_tag}}..."
    export ROLLUP_NODE_VERSION={{gasp_node_image_tag}}
    just setup-e2e-env
    cd ../gasp-e2e && yarn {{test}} || (just stop-env && exit 1)
    just stop-env
    @echo "Test {{test}} completed successfully!"

# Standard runtime tests
test-nonTransToken:
    @just run-e2e-test "test-nonTransToken" {{default_version}}

# Fast runtime tests
test-maintenance:
    @just run-e2e-test "test-maintenance" "{{default_version}}-fast"

test-rollupUpdate:
    @just run-e2e-test "test-rollupUpdate" "{{default_version}}-fast"

test-parallel-autocompound:
    @just run-e2e-test "test-parallel-autocompound" "{{default_version}}-fast"

test-sequential-autocompound:
    @just run-e2e-test "test-sequential-autocompound" "{{default_version}}-fast"

test-poolliquidity:
    @just run-e2e-test "test-poolliquidity" "{{default_version}}-fast"

test-governance:
    @just run-e2e-test "test-governance" "{{default_version}}-fast"

test-experimentalStaking:
    @just run-e2e-test "test-experimentalStaking" "{{default_version}}-fast"

test-sdk:
    @just run-e2e-test "test-sdk" "{{default_version}}-fast"

test-parallel-3rdPartyRewards:
    @just run-e2e-test "test-parallel-3rdPartyRewards" "{{default_version}}-fast"

test-sequencerStaking:
    @just run-e2e-test "test-sequencerStaking" "{{default_version}}-fast"

test-sequencerCancellation:
    @just run-e2e-test "test-sequencerCancellation" "{{default_version}}-fast"

test-rolldown:
    @just run-e2e-test "test-rolldown" "{{default_version}}-fast"

test-rolldownWithdrawal:
    @just run-e2e-test "test-rolldownWithdrawal" "{{default_version}}-fast"

test-rolldownPreOperationWithdrawal:
    @just run-e2e-test "test-rolldownPreOperationWithdrawal" "{{default_version}}-fast"

test-sequencerRewards:
    @just run-e2e-test "test-sequencerRewards" "{{default_version}}-fast"

test-issuanceConfig:
    @just run-e2e-test "test-issuanceConfig" "{{default_version}}-fast"

test-sudoRemoval:
    @just run-e2e-test "test-sudoRemoval" "{{default_version}}-fast"

# Unlocked runtime tests
test-parallel:
    @just run-e2e-test "test-parallel --max-workers=10" "{{default_version}}-unlocked"

test-sequential-no-bootstrap:
    @just run-e2e-test "test-sequential-no-bootstrap" "{{default_version}}-unlocked"

test-seqgasless:
    @just run-e2e-test "test-seqgasless" "{{default_version}}-unlocked"

test-bootstrap:
    @just run-e2e-test "test-bootstrap" "{{default_version}}-unlocked"

test-rewards-bootstrap:
    @just run-e2e-test "test-rewards-bootstrap" "{{default_version}}-unlocked"

test-multiswap:
    @just run-e2e-test "test-multiswap" "{{default_version}}-unlocked"

test-crowdloan:
    @just run-e2e-test "test-crowdloan" "{{default_version}}-unlocked"