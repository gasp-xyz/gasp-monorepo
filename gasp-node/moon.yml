type: application
language: rust
toolchain:
  rust:
    version: nightly-2024-01-20
tags:
  - 'rust-channel-1.78.0'

env:
  CARGO_TERM_COLOR: 'always'
  SCCACHE_GCS_KEY_PREFIX: gasp-node
  IMAGE_BUILD_REPOSITORY: europe-docker.pkg.dev/direct-pixel-353917/gaspxyz/rollup-node
  DOCKERHUB_REPOSITORY: gaspxyz/rollup-node

fileGroups:
  sources:
    - 'pallets/**/*'
    - 'rollup/**/*'
    - 'rpc/**/*'
    - 'Cargo.toml'

tasks:
  prepare-toolchain:
    command: rustup show
    options:
      cache: false

  build:
    command: cargo build --release
    inputs: ['@globs(sources)']
    options:
      outputStyle: 'stream'
    outputs:
      - 'target/release/rollup-node'
      - 'target/release/wbuild/rollup-runtime/rollup_runtime.compact.compressed.wasm'
    env:
      SCCACHE_GCS_KEY_PREFIX: gasp-node-release

  build-image-local:
    script: 'docker buildx build --build-arg ENABLE_FAST_RUNTIME=true -t gaspxyz/rollup-node:local --load .'
    inputs: ['@globs(sources)', 'Dockerfile']

  buildkit-build-and-push-image-digests-standard-runtime:
    command: >
      docker buildx build --platform linux/amd64,linux/arm64
      --cache-from type=registry,ref=${IMAGE_BUILD_REPOSITORY}:buildcache-standard-runtime
      --cache-to type=registry,ref=${IMAGE_BUILD_REPOSITORY}:buildcache-standard-runtime,mode=max
      --output type=image,push=true,push-by-digest=true,name=${IMAGE_BUILD_REPOSITORY}
      --build-arg ENABLE_FAST_RUNTIME=false --build-arg ENABLE_UNLOCKED_RUNTIME=false
      --metadata-file gasp-node-standard-runtime-buildkit-metadata.json -f Dockerfile ./
    inputs: ["@globs(sources)", "Dockerfile"]
    outputs: ['gasp-node-standard-runtime-buildkit-metadata.json']
    options:
      outputStyle: stream
      cache: true
      internal: false
    
  buildkit-build-and-push-image-digests-fast-runtime:
    command: >
      docker buildx build --platform linux/amd64,linux/arm64
      --cache-from type=registry,ref=${IMAGE_BUILD_REPOSITORY}:buildcache-fast-runtime
      --cache-to type=registry,ref=${IMAGE_BUILD_REPOSITORY}:buildcache-fast-runtime,mode=max
      --output type=image,push=true,push-by-digest=true,name=${IMAGE_BUILD_REPOSITORY}
      --build-arg ENABLE_FAST_RUNTIME=true --build-arg ENABLE_UNLOCKED_RUNTIME=false
      --metadata-file gasp-node-fast-runtime-buildkit-metadata.json -f Dockerfile ./
    inputs: ["@globs(sources)", "Dockerfile"]
    outputs: ['gasp-node-fast-runtime-buildkit-metadata.json']
    options:
      outputStyle: stream
      cache: true
      internal: true

  buildkit-build-and-push-image-digests-unlocked-runtime:
    command: >
      docker buildx build --platform linux/amd64,linux/arm64
      --cache-from type=registry,ref=${IMAGE_BUILD_REPOSITORY}:buildcache-unlocked-runtime
      --cache-to type=registry,ref=${IMAGE_BUILD_REPOSITORY}:buildcache-unlocked-runtime,mode=max
      --output type=image,push=true,push-by-digest=true,name=${IMAGE_BUILD_REPOSITORY}
      --build-arg ENABLE_FAST_RUNTIME=false --build-arg ENABLE_UNLOCKED_RUNTIME=true
      --metadata-file gasp-node-unlocked-runtime-buildkit-metadata.json -f Dockerfile ./
    inputs: ["@globs(sources)", "Dockerfile"]
    outputs: ['gasp-node-unlocked-runtime-buildkit-metadata.json']
    options:
      outputStyle: stream
      cache: true
      internal: true
  
  build-image-ci:
    script: |
      set -ex
      IMAGE_DIGEST_STANDARD_RUNTIME=$(jq -r '."containerimage.digest"' gasp-node-standard-runtime-buildkit-metadata.json)
      IMAGE_DIGEST_FAST_RUNTIME=$(jq -r '."containerimage.digest"' gasp-node-fast-runtime-buildkit-metadata.json)
      IMAGE_DIGEST_UNLOCKED_RUNTIME=$(jq -r '."containerimage.digest"' gasp-node-unlocked-runtime-buildkit-metadata.json)
  
      docker buildx imagetools create \
        --tag ${IMAGE_BUILD_REPOSITORY}:${IMAGE_TAG:-ci} \
        --tag ${DOCKERHUB_REPOSITORY}:${IMAGE_TAG:-ci} \
        ${IMAGE_BUILD_REPOSITORY}@${IMAGE_DIGEST_STANDARD_RUNTIME}
      echo "Successfully created ${IMAGE_BUILD_REPOSITORY}:${IMAGE_TAG:-ci} from existing digests"

      docker buildx imagetools create \
        --tag ${IMAGE_BUILD_REPOSITORY}:${IMAGE_TAG:-ci}-fast \
        --tag ${DOCKERHUB_REPOSITORY}:${IMAGE_TAG:-ci}-fast \
        ${IMAGE_BUILD_REPOSITORY}@${IMAGE_DIGEST_FAST_RUNTIME}
      echo "Successfully created ${IMAGE_BUILD_REPOSITORY}:${IMAGE_TAG:-ci}-fast from existing digests"
      
      docker buildx imagetools create \
        --tag ${IMAGE_BUILD_REPOSITORY}:${IMAGE_TAG:-ci}-unlocked \
        --tag ${DOCKERHUB_REPOSITORY}:${IMAGE_TAG:-ci}-unlocked \
        ${IMAGE_BUILD_REPOSITORY}@${IMAGE_DIGEST_UNLOCKED_RUNTIME}
      echo "Successfully created ${IMAGE_BUILD_REPOSITORY}:${IMAGE_TAG:-ci}-unlocked from existing digests"
      
    deps: ['buildkit-build-and-push-image-digests-standard-runtime', 'buildkit-build-and-push-image-digests-fast-runtime', 'buildkit-build-and-push-image-digests-unlocked-runtime']
    inputs: ['gasp-node-standard-runtime-buildkit-metadata.json', 'gasp-node-fast-runtime-buildkit-metadata.json', 'gasp-node-unlocked-runtime-buildkit-metadata.json']
    options:
      cache: false

  format-gasp-node:
    command: cargo fmt --all -- --check
    inputs: ['@globs(sources)']

  lint-gasp-node:
    command: cargo clippy -p pallet-xyk
    inputs: ['@globs(sources)']

  test-gasp-node:
    command: cargo test
    inputs: ['@globs(sources)']

  coverage-gasp-node:
    command: >
      cargo tarpaulin
      --timeout 120 --workspace --out Xml
      -e rollup-runtime-integration-test rollup-node rollup-runtime
      --exclude-files **/mock.rs **/weights.rs **/weights/* target-*-runtime
      --target-dir target-coverage
    inputs: ['@globs(sources)']
    outputs: ['cobertura.xml']
  
  benchmark-tests-gasp-node:
    script: |
      cargo test --release -j8 --features=runtime-benchmarks -p pallet-xyk -p pallet-issuance -p pallet-multipurpose-liquidity -p pallet-fee-lock
      cargo test --release -j8 --features=runtime-benchmarks -p pallet-bootstrap -p pallet-market
      # NOTE: MGX-742
      cargo test --release -j8 --features=runtime-benchmarks -p pallet-proof-of-stake
    inputs: ['@globs(sources)']
    options:
      outputStyle: stream

  build-runtime-benchmarks-gasp-node:
    command: cargo build --release --no-default-features --features=runtime-benchmarks --target-dir target-runtime-benchmarks
    inputs: ['@globs(sources)']
    options:
      internal: true
      outputStyle: stream

  run-runtime-benchmarks-gasp-node:
    script: |
      mkdir -p ./benchmarks 
      target-runtime-benchmarks/release/rollup-node benchmark pallet \
        -l=info,runtime::collective=warn,xyk=warn \
        --chain rollup-local \
        --wasm-execution compiled \
        --pallet '*' \
        --extrinsic '*' \
        --steps ${STEPS} \
        --repeat ${REPEATS} \
        --template ./templates/module-weight-template.hbs \
        --output ./benchmarks/

      target-runtime-benchmarks/release/rollup-node benchmark overhead --chain rollup-local -lblock_builder=debug --max-ext-per-block 50000 --base-path .
      cp block_weights.rs extrinsic_weights.rs ./benchmarks
    inputs: ['@globs(sources)']
    outputs: ['benchmarks']
    deps: ['build-runtime-benchmarks-gasp-node']
    env:
      STEPS: '2'
      REPEATS: '1'

  release:
    command: 'yarn run release'
    options:
      cache: false
      runInCI: false

  run-e2e-test-sudoRemoval:
    script: |
      export ROLLUP_NODE_VERSION=${ROLLUP_NODE_VERSION:-ci}-fast
      just reset-env && sleep 10
      cd e2eTests && yarn install
      yarn test-sudoRemoval || (cd ../ && just stop-env)
      cd ../ && just stop-env
    options:
      cache: true
    inputs: ['@globs(sources)']
    outputs: ['e2eTests/reports/*.xml']

  run-e2e-test-bootstrap:
    script: |
      export ROLLUP_NODE_VERSION=${ROLLUP_NODE_VERSION:-ci}-unlocked
      just reset-env && sleep 10
      cd e2eTests && yarn install
      yarn test-bootstrap || (cd ../ && just stop-env)
      cd ../ && just stop-env
    options:
      cache: true
    inputs: ['@globs(sources)']
    outputs: ['e2eTests/reports/*.xml']
    