language: typescript
type: application

toolchain:
  node:
    version: 18.20.4

fileGroups:
  sources:
    - 'src/**/*'
    - 'package.json'
    - 'tsconfig.json'

tasks:
  build:
    command: 'yarn build'
    inputs: ['@globs(sources)']
    outputs: ['build']
  
  build-image-local:
    command: 'docker buildx build -t gaspxyz/ferry-withdrawal:local -t gaspxyz/ferry-withdrawal:local -f Dockerfile --load .'
    inputs: ['@globs(sources)', 'Dockerfile']

  build-image-ci:
    # command: >
    #   docker buildx build
    #   --push
    #   --no-cache
    #   --tag gaspxyz/ferry-withdrawal:${IMAGE_TAG:-ci}
    #   --cache-to type=registry,ref=gaspxyz/ferry-withdrawal:cache,mode=max
    #   --cache-from type=registry,ref=gaspxyz/ferry-withdrawal:cache
    #   .
    command: >
      docker buildx build
      --push
      --tag gaspxyz/ferry-withdrawal:${IMAGE_TAG:-ci}
      .
    inputs: ['@globs(sources)', 'Dockerfile', '.dockerignore']
    options:
      cache: false
  
  # lint:
  #   command: 'yarn lint'
  #   inputs: ['@globs(sources)', '@globs(tests)', 'biome.json']

  release:
    command: 'yarn run release'
    options:
      cache: false
      runInCI: false