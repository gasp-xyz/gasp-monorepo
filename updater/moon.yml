type: application
language: rust
toolchain:
  rust:
    version: '1.82.0'
tags:
  - 'rust-channel-1.82.0'

env:
  CARGO_TERM_COLOR: 'always'
  SCCACHE_GCS_KEY_PREFIX: updater

fileGroups:
  sources:
    - 'bindings/**/*'
    - 'src/**/*'
    - 'Cargo.toml'

tasks:
  prepare-toolchain:
    command: rustup show
    options:
      runInCI: false
      cache: false

  build:
    command: cargo build --release
    inputs: ['@globs(sources)']
    outputs: ['target/release/main']
    env:
      SCCACHE_GCS_KEY_PREFIX: updater-release
  
  build-image-local:
    script: 'docker buildx build -t gaspxyz/updater:local -t gaspxyz/updater:localbase .'
    inputs: ['@globs(sources)', 'Dockerfile']

  build-image-ci:
    command: 'docker buildx build --platform linux/amd64 -t gaspxyz/updater:${IMAGE_TAG:-ci} -f Dockerfile.ci --push .'
    deps: ['build']
    options:
      cache: false

  format:
    command: cargo fmt --all -- --check
    inputs: ['@globs(sources)']

  lint:
    command: cargo clippy
    inputs: ['@globs(sources)']

  test:
    command: cargo test
    inputs: ['@globs(sources)']
